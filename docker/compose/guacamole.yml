# see ee-util/assets/stage_configure/initializations.sh (on update version)
# docker run --rm guacamole/guacamole:1.5.4 /opt/guacamole/bin/initdb.sh --mysql > docker/ee-util/assets/stage_configure/guacamole-init-mysql-db.sql
# modify resulting script to remove guacadmin
services:
  guacamole-guacd:
    image: guacamole/guacd:1.6.0
    security_opt:
      - no-new-privileges:true
    expose:
      - 4822
    depends_on:
      keycloak:
        condition: service_healthy
    networks:
      - backend
    mem_limit: 1G
    memswap_limit: 1G

  guacamole-guacamole:
    image: guacamole/guacamole:1.6.0
    security_opt:
      - no-new-privileges:true
    expose:
      - 8080/tcp
    depends_on: 
      - guacamole-guacd
    networks:
      - backend
    environment:
      - GUACD_HOSTNAME=guacamole-guacd
      - POSTGRESQL_ENABLED=true
      - POSTGRESQL_DATABASE=guacamole_db
      - POSTGRESQL_USERNAME=guacamole_user
      - POSTGRESQL_PASSWORD=$X_EE_RDBMS_GUACAMOLE_PASSWORD
      - POSTGRESQL_HOSTNAME=postgres
      - OPENID_ENABLED=true
      - OPENID_AUTHORIZATION_ENDPOINT=https://$EE_HOSTNAME/keycloak/auth/realms/ElexisEnvironment/protocol/openid-connect/auth
      - OPENID_JWKS_ENDPOINT=https://$EE_HOSTNAME/keycloak/auth/realms/ElexisEnvironment/protocol/openid-connect/certs
      - OPENID_ISSUER=https://$EE_HOSTNAME/keycloak/auth/realms/ElexisEnvironment
      - OPENID_CLIENT_ID=guacamole
      - OPENID_REDIRECT_URI=https://$EE_HOSTNAME/rdp
      - OPENID_USERNAME_CLAIM_TYPE=preferred_username
      - RESTRICT_ENABLED=true
      - EXTENSION_PRIORITY=openid
      - WEBAPP_CONTEXT=rdp
    mem_limit: 2G
    memswap_limit: 2G