#!/usr/bin/env bash

if [ "${1}" == "clean" ]; then
echo "DROP DATABASE $RDBMS_ELEXIS_DATABASE;"
echo "DROP DATABASE $RDBMS_BOOKSTACK_DATABASE;"
echo "DROP DATABASE $RDBMS_KEYCLOAK_DATABASE;"
echo "DROP DATABASE $RDBMS_GUACAMOLE_DATABASE;"
fi


echo "CREATE DATABASE $RDBMS_ELEXIS_DATABASE CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci;"
echo "CREATE USER $RDBMS_ELEXIS_USERNAME@'%' IDENTIFIED BY '$RDBMS_ELEXIS_PASSWORD';"
echo "GRANT ALL PRIVILEGES ON $RDBMS_ELEXIS_DATABASE.* TO '$RDBMS_ELEXIS_USERNAME'@'%';"
echo ""
echo "CREATE DATABASE $RDBMS_BOOKSTACK_DATABASE;"
echo "CREATE USER $RDBMS_BOOKSTACK_USERNAME@'%' IDENTIFIED WITH mysql_native_password BY '$RDBMS_BOOKSTACK_PASSWORD';"
echo "GRANT ALL PRIVILEGES ON $RDBMS_BOOKSTACK_DATABASE.* TO $RDBMS_BOOKSTACK_USERNAME@'%';"
echo ""
echo "CREATE DATABASE $RDBMS_KEYCLOAK_DATABASE CHARACTER SET utf8 COLLATE utf8_unicode_ci;"
echo "CREATE USER $RDBMS_KEYCLOAK_USERNAME@'%' IDENTIFIED WITH mysql_native_password BY '$RDBMS_KEYCLOAK_PASSWORD';"
echo "GRANT ALL PRIVILEGES ON $RDBMS_KEYCLOAK_DATABASE.* TO $RDBMS_KEYCLOAK_USERNAME@'%';"
echo ""
echo "CREATE DATABASE $RDBMS_NEXTCLOUD_DATABASE CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;"
echo "CREATE USER $RDBMS_NEXTCLOUD_USERNAME@'%' IDENTIFIED WITH mysql_native_password BY '$RDBMS_NEXTCLOUD_PASSWORD';"
echo "GRANT ALL PRIVILEGES ON $RDBMS_NEXTCLOUD_DATABASE.* TO $RDBMS_NEXTCLOUD_USERNAME@'%';"
echo ""
echo "CREATE DATABASE $RDBMS_GUACAMOLE_DATABASE;"
echo "CREATE USER $RDBMS_GUACAMOLE_USERNAME@'%' IDENTIFIED BY '$RDBMS_GUACAMOLE_PASSWORD';"
echo "GRANT CREATE,REFERENCES,SELECT,INSERT,UPDATE,DELETE ON $RDBMS_GUACAMOLE_DATABASE.* TO $RDBMS_GUACAMOLE_USERNAME@'%';"
echo ""
echo "FLUSH PRIVILEGES;"

echo ""
echo "===== [BOOKSTACK TEMPLATE IMPORT] ====="
echo "1) Download https://download.medelexis.ch/elexis-environment/templates/Bookstack_initial_20240403.sql"
echo "2) Restore to DB $RDBMS_BOOKSTACK_DATABASE"
echo "3) wget https://download.medelexis.ch/elexis-environment/templates/elexis-environment_bookstack_storage_uploads.tar.gz"
echo "4) docker run --rm --volumes-from elexis-environment-bookstack-1 -v $(pwd):/backup busybox tar xvzf /backup/elexis-environment_bookstack_storage_uploads.tar.gz"
echo "5) rm elexis-environment_bookstack_storage_uploads.tar.gz"
echo "6) AFTER STARTUP: ./ee cmd bookstack bookstack:update-url https://ee-master.myelexis.ch/ https://$EE_HOSTNAME/"